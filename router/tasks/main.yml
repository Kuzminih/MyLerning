---
#forward rules
# NAT settings fo  external connection 
- name: "NAT"
  iptables:
    table: 'nat'
    chain: POSTROUTING
    source: '10.10.12.0/24'
    out_interface: 'eth2'
    jump: MASQUERADE

- name: "Out packages rule Route to external network"
  iptables:
    table: 'nat'
    chain: PREROUTING
    in_interface: 'eth2'
    destination: '! 10.10.12.2'
    source: '10.10.12.0/24' # 10.10.12.1
    jump: DNAT
    to_destination: '192.168.0.1'

# Input rules for internal networks
- name: "Internal network"
  iptables:
    chain: INPUT
    source: "10.10.12.0/24"
    jump: ACCEPT

- name: "Managment network"
  iptables:
    chain: INPUT
    source: "10.10.11.0/24"
    jump: ACCEPT

# Forwarding policy for connection to external network
- name: "Forwarding for internal networks"
  iptables:
    table: 'filter'
    chain: FORWARD
    source: "10.10.12.0/24"
    jump: ACCEPT

# Drop policy
- name: "Drop other connection with INPUT policy"
  iptables:
    chain: INPUT
    policy: DROP

# Systctl settings for using forwardig scheme
- name: "sysctl"
  sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: yes
    reload: True

#Set time zone on hosts(we can apply this seeting in vagrantfile)
- name: "Set timezone to Asia/Irkutsk"
  timezone:
    name: Asia/Irkutsk
    
## tasks file for router
#- name: "Accept 22 port"
#  ansible.builtin.iptables:
#    chain: INPUT
#    source: '10.10.11.254'
#    protocol: tcp
#    destination_port: '22'
#    jump: ACCEPT
#  become: yes

#- name: "Route all packets to other hosts"
#  iptables:
#    table: nat
#    chain: PREROUTING
#    in_interface: "eth1"
#    to_destination: "10.10.12.2"
#    jump: DNAT

#- name: "Route all packets to other hosts"
#  iptables:
#    table: nat
#    chain: PREROUTING
#    in_interface: "eth1"
#    to_destination: "10.10.12.2"
#    jump: DNAT

 #- name: "Route to other hosts"
#  iptables:
#    chain: FORWARD
#    source: "192.168.0.89" #ansible host
#    dst_range: "10.10.11.0-10.10.11.254"
#    jump: ACCEPT 

